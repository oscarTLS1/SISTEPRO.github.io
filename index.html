<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">SISTEPRO - Sistema de Pedidos Restaurante</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General styles and animations */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        html { font-family: 'Inter', sans-serif; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .order-card {
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease-out;
        }
        
        .order-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        /* Table button styles */
        .table-btn {
            @apply px-4 py-3 rounded-xl font-bold transition-all duration-300 shadow-md transform hover:scale-105;
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            border: 1px solid #c0c0c0;
            color: #4a4a4a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-btn.active {
            background: linear-gradient(to bottom, #5cb85c 0%, #4cae4c 50%, #449d44 100%);
            border: 1px solid #398439;
            color: white;
            text-shadow: 0 1px 1px rgba(0,0,0,0.3);
            box-shadow: 0 4px 8px rgba(0, 200, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.4), inset 0 -1px 0 rgba(0,0,0,0.2);
            transform: scale(1.05);
        }
        .table-btn:active {
            transform: scale(0.98);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Print styles for PDF reports */
        @media print {
            /* Hide everything not explicitly needed */
            body > *:not(#app-root),
            #notification-container,
            #chart-data-modal {
                display: none !important;
            }
            #app-root {
                width: 100%;
                min-height: auto;
                display: block;
                flex-direction: column;
            }
            /* Hide header and footer of the main app for print */
            #app-root > header, #app-root > footer {
                display: none !important;
            }
            #main-content {
                padding: 0 !important;
                margin: 0 !important;
                display: block !important;
                width: 100% !important;
                flex-grow: 1;
            }
            /* Hide all top-level direct children of the admin panel main container by default */
            #main-content > div.max-w-7xl.mx-auto.space-y-8 > div {
                display: none !important;
            }

            /* Show specific sections for print */
            #admin-daily-stats, /* Daily stats summary */
            #admin-detailed-reports, /* Detailed Reports (now uses id) */
            #admin-expense-management { /* Expense Management parent */
                display: block !important;
                width: 100% !important;
                padding: 1rem !important; /* Adjust padding for print */
                background: none !important;
                box-shadow: none !important;
                border: none !important;
            }
            /* Explicitly hide the financial chart for print */
            #admin-financial-chart {
                display: none !important;
            }

            /* Specifically hide the 'Add Expense' part within Expense Management */
            #admin-expense-management > div:first-child { /* Targets the "Agregar Nuevo Gasto" div */
                display: none !important;
            }
            /* Ensure the expense history table is visible within its parent */
            #admin-expense-history-table {
                display: block !important;
                width: 100% !important;
            }

            /* General print adjustments */
            table {
                page-break-inside: auto;
                width: 100%; /* Ensure tables take full width */
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            thead {
                display: table-header-group;
            }
            /* Ensure text colors are readable on print */
            h3, h4 {
                color: #333 !important;
                text-shadow: none !important;
                background-clip: unset !important;
                -webkit-text-fill-color: unset !important;
            }
            p, span, td, th {
                color: #555 !important;
            }
            /* Hide buttons within printable sections */
            .printable-section button,
            #admin-expense-management button {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <div id="app-root">
        <!-- Content will be dynamically loaded here by JavaScript -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-xl font-semibold text-gray-700 flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                Cargando interfaz...
            </div>
        </div>
    </div>

    <!-- Notification container -->
    <div id="notification-container"></div>
    <!-- Modal to show chart data on click -->
    <div id="chart-data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-xs w-full mx-4">
            <h3 id="modal-date" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p class="text-gray-700 mb-2">Ventas: <span id="modal-sales" class="font-semibold text-green-600"></span></p>
            <p class="text-gray-700 mb-2">Gastos: <span id="modal-expenses" class="font-semibold text-red-600"></span></p>
            <p class="text-gray-700 mb-4">Ganancia Neta: <span id="modal-net-income" class="font-semibold"></span></p>
            <button onclick="document.getElementById('chart-data-modal').classList.add('hidden')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">Cerrar</button>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Import additional Auth functions for email/password and signOut
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global Variables ---
        let currentView = 'customer'; // Default view if authenticated
        let selectedItems = {};
        let currentTotal = 0;
        let tableId = ''; 
        let currentOrderFilter = 'all';
        let showCompletedOrdersInCashier = false;
        let filterStartDate = null;
        let filterEndDate = null;

        // Firebase variables
        let firebaseApp;
        let db;
        let auth;
        let restaurantAppId; // This will come from __app_id or default to 'default-restaurant-id'
        let currentUserId = 'N/A'; // User ID from Firebase Auth
        let currentUserRole = 'guest'; // Default role until authenticated and role is fetched

        // App state, now primarily managed by Firestore listeners
        const appState = {
            orders: [],
            tables: [], 
            dailyStats: { sales: 0, orders: 0, date: new Date().toDateString(), totalRevenueToday: 0, totalExpensesToday: 0 },
            menuItems: [], 
            expenses: [],
            financialHistory: [],
            restaurantName: 'SISTEPRO', 
            restaurantLogo: '', 
            lastWeeklyReportReset: new Date(),
            users: [] // Added for user management
        };

        let isFirebaseReady = false; // Flag to indicate Firebase initialization is complete

        // --- Utility Functions ---
        function generateId() {
            return Date.now().toString() + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
        }

        function showNotification(message, type = 'success', duration = 4000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className = `notification ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg mb-4 transform translate-x-full`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                    <span class="font-medium">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">√ó</button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Entrance animation
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto-remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        function getExpensesForDate(dateString) {
            return appState.expenses.filter(expense => {
                const expenseDate = new Date(expense.timestamp).toDateString();
                return expenseDate === dateString;
            })
            .reduce((sum, expense) => sum + expense.value, 0);
        }

        async function updateDailyStatsInFirestore(orderTotal) {
            const todayString = new Date().toDateString();
            const dailyStatsDocRef = doc(db, `artifacts/${restaurantAppId}/dailyStats`, todayString);
            
            const docSnap = await getDoc(dailyStatsDocRef);
            let currentSales = 0;
            let currentOrders = 0;
            let currentTotalRevenueToday = 0;
            let currentTotalExpensesToday = appState.dailyStats.totalExpensesToday; 
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentSales = data.sales || 0;
                currentOrders = data.orders || 0;
                currentTotalRevenueToday = data.totalRevenueToday || 0;
            }

            currentSales += orderTotal; 
            currentOrders += 1; 
            currentTotalRevenueToday += orderTotal; 

            await setDoc(dailyStatsDocRef, {
                sales: currentSales,
                orders: currentOrders,
                date: todayString,
                totalRevenueToday: currentTotalRevenueToday,
                totalExpensesToday: currentTotalExpensesToday 
            }, { merge: true }); 
        }

        function calculateTotal() {
            return Object.entries(selectedItems).reduce((sum, [itemId, quantity]) => {
                const item = appState.menuItems.find(i => i.id === itemId);
                return sum + (item ? item.price * quantity : 0);
            }, 0);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0 
            }).format(amount); 
        }

        function getOrdersByStatus(status) {
            if (status === 'all') return appState.orders;
            return appState.orders.filter(order => order.status === status);
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const day = d.getDay(); 
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
            d.setDate(diff);
            return d;
        }

        // --- AUTHENTICATION UI & LOGIC ---
        function renderAuthView() {
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 flex items-center justify-center">
                    <div class="bg-white/90 backdrop-blur-lg p-8 rounded-2xl shadow-2xl border border-white/20 w-full max-w-md mx-4">
                        <h2 class="text-3xl sm:text-4xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent text-center mb-8">
                            üîí Iniciar Sesi√≥n / Registrarse
                        </h2>
                        <div class="space-y-6">
                            <div>
                                <label for="auth-email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electr√≥nico:</label>
                                <input type="email" id="auth-email" placeholder="tu@ejemplo.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="auth-password" class="block text-gray-700 text-sm font-bold mb-2">Contrase√±a:</label>
                                <input type="password" id="auth-password" placeholder="********" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <button onclick="handleSignIn()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-lg shadow-md transition-colors">
                                Iniciar Sesi√≥n
                            </button>
                            <button onclick="handleSignUp()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg shadow-md transition-colors">
                                Registrarse
                            </button>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Si no tienes una cuenta, reg√≠strate. Los nuevos usuarios se asignar√°n como 'cliente'.
                        </p>
                    </div>
                </div>
            `;
        }

        async function handleSignUp() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (!email || !password) {
                showNotification('Por favor, ingresa correo y contrase√±a.', 'error');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Save user role to Firestore
                await setDoc(doc(db, `artifacts/${restaurantAppId}/users`, user.uid), {
                    email: user.email,
                    role: 'customer' // Default role for new sign-ups
                });

                showNotification('‚úÖ Registro exitoso. ¬°Bienvenido!', 'success', 4000);
                // onAuthStateChanged listener will handle UI update
            } catch (error) {
                console.error("Error during sign up:", error);
                let errorMessage = 'Error al registrarse.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este correo ya est√° registrado.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Formato de correo electr√≥nico inv√°lido.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contrase√±a debe tener al menos 6 caracteres.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = 'El registro de correo/contrase√±a no est√° habilitado. Por favor, habil√≠talo en la consola de Firebase (Authentication -> Sign-in method).';
                }
                showNotification(errorMessage, 'error');
            }
        }

        async function handleSignIn() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (!email || !password) {
                showNotification('Por favor, ingresa correo y contrase√±a.', 'error');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showNotification('‚úÖ Inicio de sesi√≥n exitoso. ¬°Bienvenido!', 'success', 4000);
                // onAuthStateChanged listener will handle UI update
            } catch (error) {
                console.error("Error during sign in:", error);
                let errorMessage = 'Error al iniciar sesi√≥n.';
                if (error.code === 'auth/invalid-email' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Correo o contrase√±a incorrectos.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = 'El inicio de sesi√≥n con correo/contrase√±a no est√° habilitado. Por favor, habil√≠talo en la consola de Firebase (Authentication -> Sign-in method).';
                }
                showNotification(errorMessage, 'error');
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                showNotification('üëã Sesi√≥n cerrada.', 'info', 3000);
                // onAuthStateChanged listener will handle UI update and renderAuthView
            } catch (error) {
                console.error("Error during sign out:", error);
                showNotification('Error al cerrar sesi√≥n.', 'error');
            }
        }

        // --- Customer View ---
        function renderCustomerView() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) {
                console.warn("main-content not found when trying to render Customer View.");
                return; // Exit gracefully if the container isn't ready
            }

            if (!checkRoleAccess(['customer', 'cashier', 'admin'])) return; // Check role
            const categorizedMenu = appState.menuItems.reduce((acc, item) => {
                if (item.available) {
                    acc[item.category] = acc[item.category] || [];
                    acc[item.category].push(item);
                }
                return acc;
            }, {});

            let customerHtml = `
                <div class="max-w-6xl mx-auto bg-white/90 backdrop-blur-lg p-4 sm:p-8 rounded-2xl shadow-2xl border border-white/20">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-4">
                            üçΩÔ∏è Realizar Pedido
                        </h2>
                        <p class="text-gray-600 text-base sm:text-lg">Selecciona tus productos favoritos desde tu mesa</p>
                    </div>

                    <div class="mb-8 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 sm:p-6 rounded-xl border border-blue-200">
                        <label class="block text-lg sm:text-xl font-bold text-gray-700 mb-3">
                            üè∑Ô∏è Selecciona tu Mesa:
                        </label>
                        <div class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-2 sm:gap-3">
                            ${appState.tables.map(num => `
                                <button onclick="setTableId('${num}')" class="table-btn ${tableId === String(num) ? 'active' : ''}">
                                    ${num === '0' ? 'üö∂ Para Llevar / Mesa 0' : `Mesa ${num}`}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8 mb-8">
            `;

            for (const category in categorizedMenu) {
                customerHtml += `
                    <div class="bg-gradient-to-br from-white to-gray-50 p-6 rounded-2xl shadow-lg border border-gray-200 hover:shadow-xl transition-all duration-300">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 border-b-2 border-gradient-to-r from-blue-400 to-purple-400 pb-3 flex items-center">
                            <span class="bg-gradient-to-r from-blue-500 to-purple-500 w-3 h-3 rounded-full mr-3"></span>
                            ${category}
                        </h3>
                `;
                
                categorizedMenu[category].forEach(item => {
                    const quantity = selectedItems[item.id] || 0;
                    customerHtml += `
                        <div class="flex items-center justify-between py-3 sm:py-4 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 rounded-lg px-2 transition-all duration-200">
                            <div class="flex-grow">
                                <div class="flex items-center mb-1 sm:mb-2">
                                    <span class="text-xl sm:text-2xl mr-2 sm:mr-3">${item.image}</span>
                                    <div>
                                        <p class="text-base sm:text-lg font-semibold text-gray-900">${item.name}</p>
                                        <p class="text-base sm:text-lg font-bold text-green-600">${formatCurrency(item.price)}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 sm:space-x-3">
                                <button
                                    onclick="handleQuantityChange('${item.id}', -1)"
                                    class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold w-8 h-8 sm:w-10 sm:h-10 rounded-full transition-all duration-200 transform hover:scale-110 shadow-lg ${quantity === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${quantity === 0 ? 'disabled' : ''}
                                >
                                    ‚àí
                                </button>
                                <input
                                    type="number"
                                    min="0"
                                    value="${quantity}"
                                    onchange="setManualQuantity('${item.id}', this.value)"
                                    class="text-lg sm:text-xl font-bold text-gray-800 w-12 text-center border rounded-md px-1 py-0.5"
                                />
                                <button
                                    onclick="handleQuantityChange('${item.id}', 1)"
                                    class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold w-8 h-8 sm:w-10 sm:h-10 rounded-full transition-all duration-200 transform hover:scale-110 shadow-lg"
                                >
                                    +
                                </button>
                            </div>
                        </div>
                    `;
                });
                customerHtml += `</div>`;
            }

            const hasItems = Object.keys(selectedItems).length > 0;
            
            customerHtml += `
                    </div>

                    <div class="bg-gradient-to-r from-blue-100 via-indigo-100 to-purple-100 p-6 sm:p-8 rounded-2xl shadow-lg mb-8 border-2 border-blue-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl sm:text-3xl font-black text-blue-800 flex items-center">
                                üí∞ Total a Pagar:
                            </h3>
                            <span id="customer-total" class="text-3xl sm:text-4xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent ${hasItems ? 'pulse-animation' : ''}">${formatCurrency(currentTotal)}</span>
                        </div>
                        ${hasItems ? `
                            <div class="mt-4 p-4 bg-white/70 rounded-xl">
                                <h4 class="font-bold text-gray-700 mb-2">üìã Resumen del pedido:</h4>
                                <div class="space-y-1 text-sm text-gray-600">
                                    ${Object.entries(selectedItems).map(([itemId, quantity]) => {
                                        const item = appState.menuItems.find(i => i.id === itemId);
                                        return `<div class="flex justify-between"><span>${item.name} x${quantity}</span><span>${formatCurrency(item.price * quantity)}</span></div>`;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div id="message-area" class="text-center mb-6"></div>

                    <button
                        onclick="handleSubmitOrder()"
                        class="w-full bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 hover:from-blue-700 hover:via-indigo-700 hover:to-purple-700 text-white font-bold py-4 sm:py-6 rounded-2xl text-xl sm:text-2xl shadow-2xl transform transition-all duration-300 hover:scale-105 hover:shadow-3xl ${!hasItems || !tableId.trim() ? 'opacity-50 cursor-not-allowed' : 'animate-pulse'}"
                        ${!hasItems || !tableId.trim() ? 'disabled' : ''}
                    >
                        üöÄ Enviar Pedido ${hasItems ? `(${Object.values(selectedItems).reduce((a, b) => a + b, 0)} items)` : ''}
                    </button>
                </div>
            `;
            
            mainContent.innerHTML = customerHtml;
            refreshCustomerTotal();
        }

        function setManualQuantity(itemId, value) {
            let newQuantity = parseInt(value);
            if (isNaN(newQuantity) || newQuantity < 0) {
                newQuantity = 0;
            }
            if (newQuantity === 0) {
                delete selectedItems[itemId];
            } else {
                selectedItems[itemId] = newQuantity;
            }
            renderCustomerView();
        }

        function setTableId(value) {
            tableId = value;
            renderCustomerView(); 
        }

        function refreshCustomerTotal() {
            currentTotal = calculateTotal();
            const totalElement = document.getElementById('customer-total');
            if (totalElement) {
                totalElement.textContent = formatCurrency(currentTotal);
                const hasItems = Object.keys(selectedItems).length > 0;
                totalElement.className = totalElement.className.replace('pulse-animation', '');
                if (hasItems) {
                    totalElement.classList.add('pulse-animation');
                }
            }
        }

        function handleQuantityChange(itemId, change) {
            const newQuantity = (selectedItems[itemId] || 0) + change;
            if (newQuantity <= 0) {
                delete selectedItems[itemId];
            } else {
                selectedItems[itemId] = newQuantity;
            }
            renderCustomerView();
        }

        async function handleSubmitOrder() {
            if (!tableId.trim()) {
                showNotification('Por favor, seleccione una mesa o "Para Llevar".', 'error');
                return;
            }
            if (Object.keys(selectedItems).length === 0) {
                showNotification('Por favor, seleccione al menos un art√≠culo.', 'error');
                return;
            }

            const orderItems = Object.entries(selectedItems).map(([itemId, quantity]) => {
                const item = appState.menuItems.find(i => i.id === itemId);
                return {
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: quantity,
                    image: item.image
                };
            });

            const newOrder = {
                id: generateId(), 
                tableId: tableId.trim(),
                items: orderItems,
                total: currentTotal,
                timestamp: new Date().toISOString(), 
                status: 'pending',
                estimatedTime: Math.ceil(orderItems.length * 3 + Math.random() * 10) 
            };

            try {
                await addDoc(collection(db, `artifacts/${restaurantAppId}/orders`), newOrder);
                showNotification(`¬°Pedido enviado con √©xito! üéâ ID: ${newOrder.id}`, 'success', 6000);
                
                selectedItems = {};
                tableId = ''; 
                currentTotal = 0;
                renderCustomerView();
                
                try {
                    new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHOu88tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmccBSuNkx9M8NqOBzuRrJ').play();
                } catch (e) {
                    console.error("Error playing sound:", e);
                }
            } catch (e) {
                console.error("Error adding document: ", e);
                showNotification('Error al enviar el pedido. Intente de nuevo.', 'error');
            }
        }

        // --- Cashier View ---
        function renderCashierView() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) {
                console.warn("main-content not found when trying to render Cashier View.");
                return; 
            }

            if (!checkRoleAccess(['cashier', 'admin'])) return; // Check role
            const pendingOrders = getOrdersByStatus('pending');
            const preparingOrders = getOrdersByStatus('preparing');
            const completedOrders = appState.orders.filter(order => order.status === 'completed');
            
            let cashierHtml = `
                <div class="max-w-7xl mx-auto space-y-8">
                    <!-- Header with statistics -->
                    <div class="bg-white/90 backdrop-blur-lg p-4 sm:p-8 rounded-2xl shadow-2xl border border-white/20">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                            <h2 class="text-3xl sm:text-4xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-4 sm:mb-0">
                                üë®‚Äçüç≥ Panel de Cajero
                            </h2>
                            <div class="flex flex-wrap justify-center gap-3 sm:space-x-4">
                                <button onclick="clearAllOrders()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 sm:px-4 sm:py-2 rounded-lg font-semibold text-sm sm:text-base transition-colors">
                                    üóëÔ∏è Limpiar Pedidos del D√≠a
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold">${appState.orders.length}</div>
                                <div class="text-blue-100 text-sm sm:text-base">Total Pedidos</div>
                            </div>
                            <div class="bg-gradient-to-br from-yellow-500 to-orange-500 text-white p-5 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold">${pendingOrders.length}</div>
                                <div class="text-yellow-100 text-sm sm:text-base">Pendientes</div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-5 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold">${preparingOrders.length}</div>
                                <div class="text-purple-100 text-sm sm:text-base">En Preparaci√≥n</div>
                            </div>
                            <button onclick="toggleCompletedOrdersInCashier()" class="relative bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-xl text-left transform transition-transform duration-200 hover:scale-[1.02] shadow-lg">
                                <div class="text-2xl sm:text-3xl font-bold">${formatCurrency(appState.dailyStats.totalRevenueToday)}</div>
                                <div class="text-green-100 text-sm sm:text-base">Ventas del D√≠a (Completadas)</div>
                                <span class="absolute bottom-2 right-3 text-lg">${showCompletedOrdersInCashier ? '‚ñ≤' : '‚ñº'}</span>
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white/90 backdrop-blur-lg p-4 sm:p-6 rounded-xl shadow-lg">
                        <div class="flex flex-wrap justify-center gap-2 sm:gap-4">
                            <button onclick="filterOrders('all')" class="filter-btn ${currentOrderFilter === 'all' ? 'active' : ''} bg-gray-500 hover:bg-gray-600 text-white px-4 py-1 sm:px-6 sm:py-2 rounded-lg font-semibold text-sm sm:text-base transition-colors">
                                Todos (${appState.orders.length})
                            </button>
                            <button onclick="filterOrders('pending')" class="filter-btn ${currentOrderFilter === 'pending' ? 'active' : ''} bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-1 sm:px-6 sm:py-2 rounded-lg font-semibold text-sm sm:text-base transition-colors">
                                Pendientes (${pendingOrders.length})
                            </button>
                            <button onclick="filterOrders('preparing')" class="filter-btn ${currentOrderFilter === 'preparing' ? 'active' : ''} bg-purple-500 hover:bg-purple-600 text-white px-4 py-1 sm:px-6 sm:py-2 rounded-lg font-semibold text-sm sm:text-base transition-colors">
                                En Preparaci√≥n (${preparingOrders.length})
                            </button>
                            <button onclick="filterOrders('completed')" class="filter-btn ${currentOrderFilter === 'completed' ? 'active' : ''} bg-green-500 hover:bg-green-600 text-white px-4 py-1 sm:px-6 sm:py-2 rounded-lg font-semibold text-sm sm:text-base transition-colors">
                                Completados (${completedOrders.length})
                            </button>
                        </div>
                    </div>

                    <!-- Order list -->
                    <div id="orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 ${currentOrderFilter === 'completed' && !showCompletedOrdersInCashier ? 'hidden' : ''}">
            `;

            const ordersToShow = getOrdersByStatus(currentOrderFilter);
            
            if (ordersToShow.length === 0) {
                cashierHtml += `
                    <div class="col-span-full text-center p-8 sm:p-16 bg-white/70 rounded-2xl">
                        <div class="text-5xl sm:text-6xl mb-4">üçΩÔ∏è</div>
                        <p class="text-lg sm:text-xl text-gray-600">No hay pedidos ${currentOrderFilter === 'all' ? '' : currentOrderFilter === 'pending' ? 'pendientes' : currentOrderFilter === 'preparing' ? 'en preparaci√≥n' : 'completados'}</p>
                    </div>
                `;
            } else {
                ordersToShow.forEach(order => {
                    const statusConfig = {
                        pending: { color: 'border-yellow-500 bg-yellow-50', badge: 'bg-yellow-200 text-yellow-800', text: 'Pendiente', icon: '‚è≥' },
                        preparing: { color: 'border-purple-500 bg-purple-50', badge: 'bg-purple-200 text-purple-800', text: 'En Preparaci√≥n', icon: 'üë®‚Äçüç≥' },
                        completed: { color: 'border-green-500 bg-green-50', badge: 'bg-green-200 text-green-800', text: 'Completado', icon: '‚úÖ' }
                    };
                    
                    const config = statusConfig[order.status];
                    const timeSince = Math.floor((new Date() - new Date(order.timestamp)) / 60000);
                    
                    let actionsHtml = '';
                    if (order.status === 'pending') {
                        actionsHtml = `
                            <button onclick="updateOrderStatus('${order.id}', 'preparing')" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 sm:py-3 rounded-lg text-base sm:text-lg shadow-md transition-colors mb-2">
                                üë®‚Äçüç≥ Iniciar Preparaci√≥n
                            </button>
                        `;
                    } else if (order.status === 'preparing') {
                        actionsHtml = `
                            <button onclick="updateOrderStatus('${order.id}', 'completed')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 sm:py-3 rounded-lg text-base sm:text-lg shadow-md transition-colors mb-2">
                                ‚úÖ Marcar Completado
                            </button>
                        `;
                    }
                    
                    actionsHtml += `
                        <button onclick="deleteOrder('${order.id}')" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg shadow-md transition-colors text-base sm:text-base">
                            üóëÔ∏è Eliminar
                        </button>
                    `;

                    const itemsHtml = order.items.map(item => `
                        <li class="flex justify-between items-center text-gray-700 py-1.5 sm:py-2 border-b border-gray-200 last:border-b-0">
                            <span class="flex items-center text-sm sm:text-base">
                                <span class="mr-1.5 sm:mr-2">${item.image}</span>
                                <span>${item.name} x${item.quantity}</span>
                            </span>
                            <span class="font-semibold text-sm sm:text-base">${formatCurrency(item.price * item.quantity)}</span>
                        </li>
                    `).join('');

                    cashierHtml += `
                        <div class="order-card bg-white/90 backdrop-blur-lg p-5 sm:p-6 rounded-2xl shadow-lg border-t-4 ${config.color} transition-all duration-300">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl sm:text-2xl font-bold text-gray-900 flex items-center">
                                    üè∑Ô∏è 
                                    <select onchange="changeOrderTable('${order.id}', this.value)" class="p-2 border rounded-md text-sm bg-gray-50">
                                        ${appState.tables.map(table => `
                                            <option value="${table}" ${order.tableId === table ? 'selected' : ''}>
                                                ${table === '0' ? 'Para Llevar' : `Mesa ${table}`}
                                            </option>
                                        `).join('')}
                                    </select>
                                </h3>
                                <span class="px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-xs sm:text-sm font-semibold ${config.badge}">
                                    ${config.icon} ${config.text}
                                </span>
                            </div>
                            
                            <div class="mb-4 bg-gray-50 rounded-lg p-3 sm:p-4">
                                <h4 class="font-semibold text-gray-700 mb-2 text-base sm:text-base">üìã Productos:</h4>
                                <ul class="space-y-1">
                                    ${itemsHtml}
                                </ul>
                            </div>
                            
                            <div class="border-t border-gray-200 pt-3 sm:pt-4 mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <p class="text-lg sm:text-xl font-bold text-gray-900">üí∞ Total:</p>
                                    <span class="text-xl sm:text-2xl font-extrabold text-blue-700">${formatCurrency(order.total)}</span>
                                </div>
                                <div class="text-xs sm:text-sm text-gray-500 space-y-1">
                                    <p>üÜî ID: ${order.id}</p>
                                    <p>üìÖ ${new Date(order.timestamp).toLocaleString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true })}</p>
                                    <p>‚è±Ô∏è Hace ${timeSince} min ${order.estimatedTime ? `| Est. ${order.estimatedTime} min` : ''}</p>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                ${actionsHtml}
                            </div>
                        </div>
                    `;
                });
            }

            mainContent.innerHTML = cashierHtml;

            const ordersListDiv = document.getElementById('orders-list');
            if (ordersListDiv) {
                if (currentOrderFilter === 'completed' && showCompletedOrdersInCashier) {
                    ordersListDiv.classList.remove('hidden');
                } else if (currentOrderFilter === 'completed' && !showCompletedOrdersInCashier) {
                    ordersListDiv.classList.add('hidden');
                } else {
                    ordersListDiv.classList.remove('hidden'); 
                }
            }
        }

        function toggleCompletedOrdersInCashier() {
            showCompletedOrdersInCashier = !showCompletedOrdersInCashier;
            if (showCompletedOrdersInCashier) {
                filterOrders('completed');
            } else {
                filterOrders('all'); 
            }
        }

        async function changeOrderTable(orderId, newTableId) {
            try {
                const orderRef = doc(db, `artifacts/${restaurantAppId}/orders`, orderId);
                await updateDoc(orderRef, { tableId: newTableId });
                showNotification(`Mesa del pedido ${orderId} cambiada a ${newTableId === '0' ? 'Para Llevar' : `Mesa ${newTableId}`}`, 'info');
            } catch (e) {
                console.error("Error updating order table:", e);
                showNotification('Error al cambiar la mesa del pedido.', 'error');
            }
        }

        function filterOrders(status) {
            currentOrderFilter = status;
            if (status === 'completed') {
                showCompletedOrdersInCashier = true;
            } else {
                showCompletedOrdersInCashier = false;
            }
            renderCashierView();
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const orderRef = doc(db, `artifacts/${restaurantAppId}/orders`, orderId);
                const orderSnap = await getDoc(orderRef);
                if (orderSnap.exists()) {
                    const orderData = orderSnap.data();
                    const oldStatus = orderData.status;
                    let updateData = { status: newStatus };

                    if (newStatus === 'preparing') {
                        updateData.startedAt = new Date().toISOString();
                    } else if (newStatus === 'completed') {
                        updateData.completedAt = new Date().toISOString();
                        if (oldStatus !== 'completed') { 
                            await updateDailyStatsInFirestore(orderData.total); 
                        }
                    }
                    await updateDoc(orderRef, updateData);
                    
                    const statusMessages = {
                        preparing: 'üë®‚Äçüç≥ Pedido marcado como "En Preparaci√≥n"',
                        completed: '‚úÖ Pedido completado exitosamente'
                    };
                    showNotification(statusMessages[newStatus], 'success');
                }
            } catch (e) {
                console.error("Error updating order status:", e.code, e.message, e); // Improved logging
                showNotification(`Error al actualizar el estado del pedido: ${e.message}. Aseg√∫rate de tener permisos.`, 'error');
            }
        }

        async function deleteOrder(orderId) {
            showCustomConfirmation('¬øEst√°s seguro de que quieres eliminar este pedido? Nota: Si este pedido ya fue completado, sus ventas permanecer√°n en las estad√≠sticas del d√≠a.', async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${restaurantAppId}/orders`, orderId));
                    showNotification('üóëÔ∏è Pedido eliminado', 'info');
                } catch (e) {
                    console.error("Error deleting order:", e.code, e.message, e); // Improved logging
                    showNotification(`Error al eliminar el pedido: ${e.message}.`, 'error');
                }
            });
        }

        async function clearAllOrders() {
            showCustomConfirmation('¬øEst√°s seguro de que quieres eliminar TODOS los pedidos PENDIENTES y EN PREPARACI√ìN? Los pedidos completados se mantendr√°n para los reportes detallados y no ser√°n eliminados. Para reiniciar las estad√≠sticas diarias y reportes semanales, el sistema lo hace autom√°ticamente al inicio de un nuevo d√≠a/semana.', async () => {
                try {
                    const q = query(collection(db, `artifacts/${restaurantAppId}/orders`));
                    const querySnapshot = await getDocs(q);
                    
                    const batch = db.batch();
                    querySnapshot.forEach((docSnap) => {
                        const orderData = docSnap.data();
                        if (orderData.status === 'pending' || orderData.status === 'preparing') {
                            batch.delete(docSnap.ref);
                        }
                    });
                    await batch.commit();
                    showNotification('üóëÔ∏è Pedidos pendientes y en preparaci√≥n eliminados. Los datos de reportes no se vieron afectados.', 'info');
                } catch (e) {
                    console.error("Error clearing orders:", e.code, e.message, e); // Improved logging
                    showNotification(`Error al limpiar pedidos: ${e.message}.`, 'error');
                }
            });
        }

        function exportDataToCSV() { 
            let csvContent = "";

            if (appState.orders.length > 0) {
                csvContent += "Pedidos\n";
                const orderHeaders = ["ID", "Mesa", "Total", "Fecha y Hora", "Estado", "Tiempo Estimado (min)", "Items"];
                csvContent += orderHeaders.map(h => `"${h}"`).join(",") + "\n";
                appState.orders.forEach(order => {
                    const itemsSummary = order.items.map(item => `${item.name} (x${item.quantity})`).join("; ");
                    const row = [
                        `"${order.id}"`,
                        `"${order.tableId}"`,
                        order.total.toFixed(0), 
                        `"${new Date(order.timestamp).toLocaleString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true })}"`,
                        `"${order.status}"`,
                        `"${order.estimatedTime || 'N/A'}"`,
                        `"${itemsSummary}"`
                    ];
                    csvContent += row.join(",") + "\n";
                });
                csvContent += "\n";
            }

            if (appState.expenses.length > 0) {
                csvContent += "Gastos\n";
                const expenseHeaders = ["ID", "Descripci√≥n", "Valor", "Fecha y Hora"];
                csvContent += expenseHeaders.map(h => `"${h}"`).join(",") + "\n";
                appState.expenses.forEach(expense => {
                    const row = [
                        `"${expense.id}"`,
                        `"${expense.description}"`,
                        expense.value.toFixed(0), 
                        `"${new Date(expense.timestamp).toLocaleString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true })}"`
                    ];
                    csvContent += row.join(",") + "\n";
                });
                csvContent += "\n";
            }

            if (appState.financialHistory.length > 0) {
                csvContent += "Historial_Financiero_Diario\n";
                const historyHeaders = ["Fecha", "Ventas_Diarias", "Gastos_Diarios", "Ganancia_Neta_Diaria"];
                csvContent += historyHeaders.map(h => `"${h}"`).join(",") + "\n";
                appState.financialHistory.forEach(entry => {
                    const netIncome = entry.sales - entry.expenses;
                    const row = [
                        `"${entry.date}"`,
                        entry.sales.toFixed(0), 
                        entry.expenses.toFixed(0),
                        netIncome.toFixed(0)
                    ];
                    csvContent += row.join(",") + "\n";
                });
                csvContent += "\n";
            }

            const dataBlob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `sistepro_datos_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('üìä Datos exportados a CSV exitosamente', 'success');
        }

        // --- User View ---
        function renderUserView() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) {
                console.warn("main-content not found when trying to render User View.");
                return; 
            }
            if (!checkRoleAccess(['customer', 'cashier', 'admin'])) return; // Check role
            let userHtml = `
                <div class="max-w-xl mx-auto bg-white/90 backdrop-blur-lg p-6 sm:p-8 rounded-2xl shadow-2xl border border-white/20">
                    <h2 class="text-3xl sm:text-4xl font-black bg-gradient-to-r from-blue-600 to-green-600 bg-clip-text text-transparent mb-8">
                        üë§ Panel de Usuario / Configuraci√≥n
                    </h2>
                    <div class="space-y-6">
                        <div>
                            <label for="restaurantNameInput" class="block text-gray-700 text-sm font-bold mb-2">Nombre del Restaurante:</label>
                            <input type="text" id="restaurantNameInput" value="${appState.restaurantName}" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                        </div>
                        <div>
                            <label for="restaurantLogoInput" class="block text-gray-700 text-sm font-bold mb-2">URL del Logo (opcional):</label>
                            <input type="text" id="restaurantLogoInput" value="${appState.restaurantLogo}" placeholder="Ej: https://example.com/logo.png" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                            ${appState.restaurantLogo ? `<div class="mt-4 text-center"><img src="${appState.restaurantLogo}" alt="Logo del restaurante" class="max-w-[150px] max-h-[150px] mx-auto rounded-full shadow-md"></div>` : ''}
                        </div>
                        <button onclick="saveRestaurantSettings()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-base sm:text-base">
                            üíæ Guardar Configuraci√≥n
                        </button>
                    </div>
                </div>
            `;
            mainContent.innerHTML = userHtml;
        }

        async function saveRestaurantSettings() {
            const newName = document.getElementById('restaurantNameInput').value.trim();
            const newLogo = document.getElementById('restaurantLogoInput').value.trim();

            if (!newName) {
                showNotification('El nombre del restaurante no puede estar vac√≠o.', 'error');
                return;
            }

            try {
                const settingsDocRef = doc(db, `artifacts/${restaurantAppId}/settings`, 'restaurantSettings');
                await setDoc(settingsDocRef, { 
                    restaurantName: newName, 
                    restaurantLogo: newLogo 
                }, { merge: true });
                showNotification('‚úÖ Configuraci√≥n del restaurante guardada.', 'success');
            } catch (e) {
                console.error("Error saving restaurant settings:", e.code, e.message, e); // Improved logging
                showNotification(`Error al guardar la configuraci√≥n del restaurante: ${e.message}.`, 'error');
            }
        }

        // --- Admin View ---
        function renderAdminView() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) {
                console.warn("main-content not found when trying to render Admin View.");
                return; 
            }
            if (!checkRoleAccess(['admin'])) return; // Check role
            const today = new Date();
            const startOfCurrentWeek = getStartOfWeek(today);

            const filteredFinancialHistory = appState.financialHistory.filter(entry => {
                const entryDate = new Date(entry.date);
                if (filterStartDate && entryDate < filterStartDate) return false;
                if (filterEndDate && entryDate > filterEndDate) return false;
                return true;
            });

            const dailyRevenueToday = appState.dailyStats.totalRevenueToday;
            const dailyExpensesToday = appState.dailyStats.totalExpensesToday; 
            const dailyNetIncomeToday = dailyRevenueToday - dailyExpensesToday;

            const completedOrdersThisWeek = appState.orders.filter(order => 
                order.status === 'completed' && new Date(order.timestamp) >= startOfCurrentWeek
            );
            
            const totalSalesAllTime = completedOrdersThisWeek.reduce((sum, order) => sum + order.total, 0);
            const averageOrderValue = completedOrdersThisWeek.length > 0 ? totalSalesAllTime / completedOrdersThisWeek.length : 0;
            
            const productSales = {};
            const categorySales = {};

            completedOrdersThisWeek.forEach(order => {
                order.items.forEach(item => {
                    if (!productSales[item.name]) {
                        productSales[item.name] = { quantity: 0, revenue: 0 };
                    }
                    productSales[item.name].quantity += item.quantity;
                    productSales[item.name].revenue += item.price * item.quantity;

                    const menuItem = appState.menuItems.find(mi => mi.id === item.id);
                    const category = menuItem ? menuItem.category : 'Desconocido';
                    if (!categorySales[category]) {
                        categorySales[category] = { quantity: 0, revenue: 0 };
                    }
                    categorySales[category].quantity += item.quantity;
                    categorySales[category].revenue += item.price * item.quantity;
                });
            });

            const sortedProductSales = Object.entries(productSales).sort(([, a], [, b]) => b.revenue - a.revenue);
            const sortedCategorySales = Object.entries(categorySales).sort(([, a], [, b]) => b.revenue - a.revenue);

            const salesByHour = Array(24).fill(0); 
            const salesByDayOfWeek = Array(7).fill(0); 

            completedOrdersThisWeek.forEach(order => {
                const orderDate = new Date(order.timestamp);
                const hour = orderDate.getHours();
                const dayOfWeek = orderDate.getDay(); 

                salesByHour[hour] += order.total;
                salesByDayOfWeek[dayOfWeek] += order.total;
            });

            const daysOfWeekNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

            const displayHours = [];
            for (let i = 6; i <= 23; i++) { 
                const displayHour = i % 12 === 0 ? 12 : i % 12;
                const ampm = i < 12 ? 'AM' : 'PM';
                displayHours.push({
                    time: `${displayHour}${ampm}`,
                    revenue: salesByHour[i] 
                });
            }

            let adminHtml = `
                <div class="max-w-7xl mx-auto space-y-8 p-4 sm:p-6">
                    <div id="admin-daily-stats" class="bg-white/90 backdrop-blur-lg p-6 sm:p-8 rounded-2xl shadow-2xl border border-white/20">
                        <h2 class="text-3xl sm:text-4xl font-black bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-8">
                            ‚öôÔ∏è Panel de Administraci√≥n
                        </h2>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-5 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold">${formatCurrency(dailyRevenueToday)}</div>
                                <div class="text-blue-100 text-sm sm:text-base">Ingresos Diarios</div>
                            </div>
                            <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-5 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold">${formatCurrency(dailyExpensesToday)}</div>
                                <div class="text-red-100 text-sm sm:text-base">Gastos Diarios</div>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-5 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold">${formatCurrency(dailyNetIncomeToday)}</div>
                                <div class="text-green-100 text-sm sm:text-base">Ganancia Neta Diaria</div>
                            </div>
                            <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-5 rounded-xl">
                                <div class="text-2xl sm:text-3xl font-bold">${formatCurrency(averageOrderValue)}</div>
                                <div class="text-orange-100 text-sm sm:text-base">Ticket Promedio (Semanal)</div>
                            </div>
                        </div>
                        <div class="mt-8 flex justify-center">
                            <button onclick="switchView('user-management')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold text-base sm:text-lg shadow-md transition-all duration-300 transform hover:scale-105">
                                üßë‚Äçüíª Gesti√≥n de Usuarios
                            </button>
                        </div>
                    </div>

                    <div id="admin-financial-chart" class="bg-gray-50 p-6 rounded-xl mb-8">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4">üìà Historial Financiero Diario</h3>
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <div>
                                <label for="startDate" class="block text-gray-700 text-sm font-bold mb-1">Desde:</label>
                                <input type="date" id="startDate" class="p-2 border rounded-lg w-full" onchange="applyDateFilter()">
                            </div>
                            <div>
                                <label for="endDate" class="block text-gray-700 text-sm font-bold mb-1">Hasta:</label>
                                <input type="date" id="endDate" class="p-2 border rounded-lg w-full" onchange="applyDateFilter()">
                            </div>
                            <button onclick="clearDateFilter()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold self-end">
                                Limpiar Filtro
                            </button>
                        </div>
                        <p class="text-gray-600 mb-4 text-sm sm:text-base">Ventas (verde), Gastos (rojo) y Ganancia Neta (azul/rosa) del per√≠odo seleccionado. Haz clic en la barra para ver detalles.</p>
                        <div class="flex items-end justify-start h-48 border-b border-l border-gray-300 overflow-x-auto pb-2 pr-2">
                            ${filteredFinancialHistory.map(entry => {
                                const allValues = filteredFinancialHistory.flatMap(d => [d.sales, d.expenses, Math.abs(d.sales - d.expenses)]); 
                                const maxVal = allValues.length > 0 ? Math.max(...allValues) : 1;
                                const salesHeight = maxVal > 0 ? (entry.sales / maxVal) * 80 : 0; 
                                const expensesHeight = maxVal > 0 ? (entry.expenses / maxVal) * 80 : 0;
                                const netIncome = entry.sales - entry.expenses;
                                const netIncomeHeight = maxVal > 0 ? (Math.abs(netIncome) / maxVal) * 80 : 0;
                                const netIncomeColor = netIncome >= 0 ? 'bg-blue-500' : 'bg-pink-500';

                                return `
                                    <div class="flex flex-col items-center mx-1 group relative flex-shrink-0 cursor-pointer" style="width: 24px;"
                                         onclick="showChartData('${entry.date}', ${entry.sales}, ${entry.expenses})">
                                        <div class="flex flex-col-reverse h-full w-full">
                                            <div class="w-full ${netIncomeColor} transition-all duration-300 ease-out rounded-b-sm" style="height: ${netIncomeHeight}%;"></div>
                                            <div class="w-full bg-red-500 transition-all duration-300 ease-out" style="height: ${expensesHeight}%;"></div>
                                            <div class="w-full bg-green-500 transition-all duration-300 ease-out rounded-t-sm" style="height: ${salesHeight}%;"></div>
                                        </div>
                                        <span class="text-xs text-gray-600 mt-1">${new Date(entry.date).getDate()}</span>
                                        <div class="absolute bottom-full left-1/2 -translate-x-1/2 p-2 bg-gray-800 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap z-10">
                                            ${new Date(entry.date).toLocaleDateString('es-ES')}<br>
                                            Ventas: ${formatCurrency(entry.sales)}<br>
                                            Gastos: ${formatCurrency(entry.expenses)}<br>
                                            Ganancia: ${formatCurrency(netIncome)}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="flex justify-start text-xs text-gray-700 mt-2">
                            <span class="mr-4 flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span> Ventas</span>
                            <span class="mr-4 flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span> Gastos</span>
                            <span class="mr-4 flex items-center"><span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span> Ganancia</span>
                            <span class="mr-4 flex items-center"><span class="w-3 h-3 bg-pink-500 rounded-full mr-1"></span> P√©rdida</span>
                        </div>
                    </div>

                    <div id="admin-detailed-reports" class="bg-gray-50 p-6 rounded-xl mb-8 printable-section">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4 flex justify-between items-center">
                            üìä Reportes Detallados (Semanal)
                            <button onclick="exportDataToCSV()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm sm:text-base transition-colors ml-4">
                                üìÑ Exportar a CSV
                            </button>
                        </h3>
                        <p class="text-gray-600 mb-4 text-sm sm:text-base">Nota: Estos reportes se basan en los pedidos marcados como "Completados" durante la semana actual. Si no hay pedidos completados en la semana, es posible que no veas datos.</p>
                        
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold mb-3">Ventas por Producto (Top 5)</h4>
                            ${sortedProductSales.length === 0 ? '<p class="text-gray-500 text-sm">No hay datos de ventas de productos para esta semana.</p>' : `
                            <div class="max-h-48 overflow-y-auto">
                                <table class="min-w-full bg-white rounded-lg shadow-sm text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="py-2 px-3 text-left font-bold">Producto</th>
                                            <th class="py-2 px-3 text-left font-bold">Cantidad</th>
                                            <th class="py-2 px-3 text-left font-bold">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sortedProductSales.slice(0, 5).map(([name, stats]) => `
                                            <tr class="border-b last:border-b-0">
                                                <td class="py-2 px-3">${name}</td>
                                                <td class="py-2 px-3">${stats.quantity}</td>
                                                <td class="py-2 px-3 font-semibold">${formatCurrency(stats.revenue)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `}
                        </div>

                        <div class="mb-6">
                            <h4 class="text-lg font-semibold mb-3">Ventas por Categor√≠a</h4>
                            ${sortedCategorySales.length === 0 ? '<p class="text-gray-500 text-sm">No hay datos de ventas por categor√≠a para esta semana.</p>' : `
                            <div class="max-h-48 overflow-y-auto">
                                <table class="min-w-full bg-white rounded-lg shadow-sm text-sm">
                                    <thead>
                                        <tr class="bg-gray-100 border-b">
                                            <th class="py-2 px-3 text-left font-bold">Categor√≠a</th>
                                            <th class="py-2 px-3 text-left font-bold">Cantidad</th>
                                            <th class="py-2 px-3 text-left font-bold">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sortedCategorySales.map(([category, stats]) => `
                                            <tr class="border-b last:border-b-0">
                                                <td class="py-2 px-3">${category}</td>
                                                <td class="py-2 px-3">${stats.quantity}</td>
                                                <td class="py-2 px-3 font-semibold">${formatCurrency(stats.revenue)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            `}
                        </div>

                        <div class="mb-6">
                            <h4 class="text-lg font-semibold mb-3">Ventas por Hora del D√≠a (6 AM - 11:59 PM)</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
                                ${displayHours.map(data => `
                                    <div class="bg-white p-3 rounded-lg border flex justify-between items-center">
                                        <span>${data.time}</span>
                                        <span class="font-semibold">${formatCurrency(data.revenue)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div>
                            <h4 class="text-lg font-semibold mb-3">Ventas por D√≠a de la Semana</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm">
                                ${salesByDayOfWeek.map((revenue, dayIndex) => `
                                    <div class="bg-white p-3 rounded-lg border flex justify-between items-center">
                                        <span>${daysOfWeekNames[dayIndex]}</span>
                                        <span class="font-semibold">${formatCurrency(revenue)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div id="admin-expense-management" class="bg-gray-50 p-6 rounded-xl mb-8">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4">üí∏ Gesti√≥n de Gastos</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-3">Agregar Nuevo Gasto</h4>
                                <div class="space-y-3">
                                    <input id="newExpenseDescription" type="text" placeholder="Descripci√≥n del gasto" class="w-full p-3 border rounded-lg text-sm sm:text-base">
                                    <input id="newExpenseValue" type="number" step="1" placeholder="Valor del gasto" class="w-full p-3 border rounded-lg text-sm sm:text-base">
                                    <button onclick="addExpense()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg text-base sm:text-base">
                                        ‚ûï Agregar Gasto
                                    </button>
                                </div>
                            </div>
                            
                            <div id="admin-expense-history-table">
                                <h4 class="text-lg font-semibold mb-3">Historial de Gastos Detallado (Hoy: ${formatCurrency(dailyExpensesToday)})</h4>
                                <div class="space-y-3 max-h-64 overflow-y-auto">
                                    ${appState.expenses.length === 0 ? '<p class="text-gray-500 text-sm">No hay gastos registrados.</p>' : ''}
                                    ${appState.expenses.map(expense => `
                                        <div class="bg-white p-4 rounded-lg border flex justify-between items-center">
                                            <div>
                                                <span class="font-semibold text-base">${expense.description}</span>
                                                <p class="text-sm text-gray-600">${formatCurrency(expense.value)}</p>
                                                <p class="text-xs text-gray-400">${new Date(expense.timestamp).toLocaleString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true })}</p>
                                            </div>
                                            <button onclick="deleteExpense('${expense.id}')" class="px-2 py-1 text-xs bg-red-200 text-red-800 rounded">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick="clearAllExpenses()" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors mt-4 text-sm sm:text-base">
                                    üóëÔ∏è Limpiar Todos los Gastos
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl mb-8">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4">ü™ë Gesti√≥n de Mesas</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-3">Agregar Nueva Mesa</h4>
                                <div class="flex space-x-2">
                                    <input id="newTableId" type="number" min="1" placeholder="N√∫mero de mesa" class="w-full p-3 border rounded-lg text-sm sm:text-base">
                                    <button onclick="addTable()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-base sm:text-base">
                                        ‚ûï
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold mb-3">Mesas Actuales</h4>
                                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 max-h-48 overflow-y-auto">
                                    ${appState.tables.filter(id => id !== '0').sort((a,b) => parseInt(a)-parseInt(b)).map(id => `
                                        <div class="flex items-center justify-between bg-white p-2 rounded-lg shadow-sm border text-sm">
                                            Mesa ${id}
                                            <button onclick="deleteTable('${id}')" class="ml-2 px-1.5 py-0.5 text-xs bg-red-200 text-red-800 rounded">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4">üçΩÔ∏è Gesti√≥n de Men√∫</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-3">Agregar Nuevo Producto</h4>
                                <div class="space-y-3">
                                    <input id="newItemName" type="text" placeholder="Nombre del producto" class="w-full p-3 border rounded-lg text-sm sm:text-base">
                                    <input id="newItemPrice" type="number" step="1" placeholder="Precio" class="w-full p-3 border rounded-lg text-sm sm:text-base">
                                    <select id="newItemCategory" class="w-full p-3 border rounded-lg text-sm sm:text-base">
                                        <option value="">Seleccionar categor√≠a</option>
                                        <option value="Bebidas Calientes">Bebidas Calientes</option>
                                        <option value="Bebidas Fr√≠as">Bebidas Fr√≠as</option>
                                        <option value="Panader√≠a">Panader√≠a</option>
                                        <option value="Postres">Postres</option>
                                        <option value="Comidas">Comidas</option>
                                    </select>
                                    <select id="newItemImage" class="w-full p-3 border rounded-lg text-xl">
                                        <option value="üçΩÔ∏è">üçΩÔ∏è Gen√©rico</option>
                                        <option value="‚òï">‚òï Caf√©</option>
                                        <option value="ü•§">ü•§ Bebida</option>
                                        <option value="ü•ê">ü•ê Panader√≠a</option>
                                        <option value="üç∞">üç∞ Postre</option>
                                        <option value="üçï">üçï Comida</option>
                                        <option value="üçî">üçî Hamburguesa</option>
                                        <option value="ü•™">ü•™ Sandwich</option>
                                        <option value="ü•ó">ü•ó Ensalada</option>
                                        <option value="üçù">üçù Pasta</option>
                                        <option value="ÔøΩ">ü•ß Tarta</option>
                                        <option value="üç´">üç´ Brownie</option>
                                        <option value="üçÆ">üçÆ Tiramis√∫</option>
                                        <option value="üßÉ">üßÉ Jugo</option>
                                        <option value="üçã">üçã Limonada</option>
                                        <option value="üßä">üßä T√© Helado</option>
                                        <option value="üçû">üçû Pan</option>
                                        <option value="üßÅ">üßÅ Muffin</option>
                                        <option value="ü•Ø">ü•Ø Bagel</option>
                                    </select>
                                    <button onclick="addMenuItem()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-base sm:text-base">
                                        ‚ûï Agregar Producto
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="text-lg font-semibold mb-3">Estad√≠sticas por Categor√≠a</h4>
                                <div class="space-y-3 max-h-64 overflow-y-auto">
            `;
            
            Object.entries(categorySales).forEach(([category, stats]) => { 
                adminHtml += `
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex justify-between items-center text-sm sm:text-base">
                            <span class="font-semibold">${category}</span>
                            <span class="text-xs sm:text-sm text-gray-500">${stats.quantity} vendidos</span>
                        </div>
                        <div class="text-green-600 font-bold text-base sm:text-lg">${formatCurrency(stats.revenue)}</div>
                    </div>
                `;
            });

            adminHtml += `
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h3 class="text-xl sm:text-2xl font-bold mb-4">üìã Productos del Men√∫</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
            `;

            appState.menuItems.forEach(item => {
                adminHtml += `
                    <div class="bg-white p-4 rounded-lg border ${item.available ? '' : 'opacity-50'}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center">
                                <span class="text-xl sm:text-2xl mr-2">${item.image}</span>
                                <div>
                                    <h4 class="font-semibold text-base sm:text-base">${item.name}</h4>
                                    <p class="text-xs sm:text-sm text-gray-600">${item.category}</p>
                                </div>
                            </div>
                            <div class="flex space-x-1 sm:space-x-2">
                                <button onclick="toggleItemAvailability('${item.id}')" 
                                    class="px-1.5 py-0.5 text-xs sm:px-2 sm:py-1 rounded ${item.available ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                                    ${item.available ? '‚úÖ' : '‚ùå'}
                                </button>
                                <button onclick="deleteMenuItem('${item.id}')" class="px-1.5 py-0.5 text-xs sm:px-2 sm:py-1 bg-red-200 text-red-800 rounded">
                                    üóëÔ∏è
                                </button>
                                <button onclick="openEditItemModal('${item.id}')" class="px-1.5 py-0.5 text-xs sm:px-2 sm:py-1 rounded bg-blue-200 text-blue-800">
                                    ‚úèÔ∏è
                                </button>
                            </div>
                        </div>
                        <div class="text-base sm:text-lg font-bold text-green-600">${formatCurrency(item.price)}</div>
                    </div>
                `;
            });

            mainContent.innerHTML = adminHtml;
            if (filterStartDate) {
                document.getElementById('startDate').valueAsDate = filterStartDate;
            }
            if (filterEndDate) {
                document.getElementById('endDate').valueAsDate = filterEndDate;
            }
        }

        async function addMenuItem() {
            const name = document.getElementById('newItemName').value.trim();
            const price = parseFloat(document.getElementById('newItemPrice').value); 
            const category = document.getElementById('newItemCategory').value;
            const image = document.getElementById('newItemImage').value;

            if (!name || isNaN(price) || price <= 0 || !category) {
                showNotification('Por favor, completa todos los campos y asegura que el precio sea v√°lido.', 'error');
                return;
            }

            const newItem = {
                id: generateId(), 
                name,
                price,
                category,
                image,
                available: true
            };

            try {
                await addDoc(collection(db, `artifacts/${restaurantAppId}/menuItems`), newItem);
                showNotification(`‚úÖ Producto "${name}" agregado exitosamente`, 'success');
                document.getElementById('newItemName').value = '';
                document.getElementById('newItemPrice').value = '';
                document.getElementById('newItemCategory').value = '';
                document.getElementById('newItemImage').value = 'üçΩÔ∏è';
            } catch (e) {
                console.error("Error adding menu item:", e.code, e.message, e); // Improved logging
                showNotification(`Error al agregar el producto al men√∫: ${e.message}.`, 'error');
            }
        }

        async function toggleItemAvailability(itemId) {
            try {
                const itemRef = doc(db, `artifacts/${restaurantAppId}/menuItems`, itemId);
                const itemSnap = await getDoc(itemRef);
                if (itemSnap.exists()) {
                    const currentAvailability = itemSnap.data().available;
                    await updateDoc(itemRef, { available: !currentAvailability });
                    showNotification(`${!currentAvailability ? '‚úÖ Producto activado' : '‚ùå Producto desactivado'}`, 'info');
                }
            } catch (e) {
                console.error("Error toggling item availability:", e.code, e.message, e); // Improved logging
                showNotification(`Error al cambiar la disponibilidad del producto: ${e.message}.`, 'error');
            }
        }

        async function deleteMenuItem(itemId) {
            showCustomConfirmation('¬øEst√°s seguro de que quieres eliminar este producto del men√∫? Esta acci√≥n es irreversible.', async () => {
                try {
                    await deleteDoc(doc(db, `artifacts/${restaurantAppId}/menuItems`, itemId));
                    showNotification('üóëÔ∏è Producto eliminado del men√∫', 'info');
                } catch (e) {
                    console.error("Error deleting menu item:", e.code, e.message, e); // Improved logging
                    showNotification(`Error al eliminar el producto del men√∫: ${e.message}.`, 'error');
                }
            });
        }

        // --- Expense Management Functions ---
        async function addExpense() {
            const description = document.getElementById('newExpenseDescription').value.trim();
            const value = parseFloat(document.getElementById('newExpenseValue').value); 

            if (!description || isNaN(value) || value <= 0) {
                showNotification('Por favor, ingresa una descripci√≥n y un valor v√°lido para el gasto.', 'error');
                return;
            }

            const newExpense = {
                id: generateId(), 
                description,
                value,
                timestamp: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, `artifacts/${restaurantAppId}/expenses`), newExpense);
                const todayString = new Date().toDateString();
                const dailyStatsDocRef = doc(db, `artifacts/${restaurantAppId}/dailyStats`, todayString);
                
                const docSnap = await getDoc(dailyStatsDocRef);
                let currentTotalExpensesToday = 0;
                if (docSnap.exists()) {
                    currentTotalExpensesToday = docSnap.data().totalExpensesToday || 0;
                }
                await setDoc(dailyStatsDocRef, { totalExpensesToday: currentTotalExpensesToday + value }, { merge: true });

                showNotification(`üí∏ Gasto "${description}" agregado exitosamente`, 'success');
                document.getElementById('newExpenseDescription').value = '';
                document.getElementById('newExpenseValue').value = '';
            } catch (e) {
                console.error("Error adding expense:", e.code, e.message, e); // Improved logging
                showNotification(`Error al agregar el gasto: ${e.message}.`, 'error');
            }
        }

        async function deleteExpense(expenseId) {
            showCustomConfirmation('¬øEst√°s seguro de que quieres eliminar este gasto?', async () => {
                try {
                    const expenseRef = doc(db, `artifacts/${restaurantAppId}/expenses`, expenseId);
                    const expenseSnap = await getDoc(expenseRef);
                    if (expenseSnap.exists()) {
                        const expenseValue = expenseSnap.data().value;
                        const expenseDate = new Date(expenseSnap.data().timestamp).toDateString();

                        const dailyStatsDocRef = doc(db, `artifacts/${restaurantAppId}/dailyStats`, expenseDate);
                        const dailyStatsSnap = await getDoc(dailyStatsDocRef);
                        if (dailyStatsSnap.exists()) {
                            const currentTotalExpensesToday = dailyStatsSnap.data().totalExpensesToday || 0;
                            await updateDoc(dailyStatsDocRef, { totalExpensesToday: currentTotalExpensesToday - expenseValue });
                        }
                    }
                    await deleteDoc(expenseRef);
                    showNotification('üóëÔ∏è Gasto eliminado', 'info');
                } catch (e) {
                    console.error("Error deleting expense:", e.code, e.message, e); // Improved logging
                    showNotification(`Error al eliminar el gasto: ${e.message}.`, 'error');
                }
            });
        }

        async function clearAllExpenses() {
            showCustomConfirmation('¬øEst√°s seguro de que quieres eliminar TODOS los gastos? Esta acci√≥n es irreversible.', async () => {
                try {
                    const q = query(collection(db, `artifacts/${restaurantAppId}/expenses`));
                    const querySnapshot = await getDocs(q);
                    const batch = db.batch();
                    querySnapshot.forEach((docSnap) => {
                        batch.delete(docSnap.ref);
                    });
                    await batch.commit();

                    const dailyStatsCollectionRef = collection(db, `artifacts/${restaurantAppId}/dailyStats`);
                    const dailyStatsSnapshot = await getDocs(dailyStatsCollectionRef);
                    const dailyStatsBatch = db.batch();
                    dailyStatsSnapshot.forEach((docSnap) => {
                        dailyStatsBatch.update(docSnap.ref, { totalExpensesToday: 0 });
                    });
                    await dailyStatsBatch.commit();

                    showNotification('üóëÔ∏è Todos los gastos han sido eliminados', 'info');
                } catch (e) {
                    console.error("Error clearing all expenses:", e.code, e.message, e); // Improved logging
                    showNotification(`Error al limpiar todos los gastos: ${e.message}.`, 'error');
                }
            });
        }

        function showCustomConfirmation(message, onConfirm) {
            const existingModal = document.getElementById('custom-confirmation-modal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="custom-confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full mx-4">
                        <p class="text-xl font-semibold text-gray-800 mb-6">${message}</p>
                        <div class="flex justify-end space-x-4">
                            <button id="confirm-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                                Cancelar
                            </button>
                            <button id="confirm-ok-btn" class="px-6 py-2 rounded-lg bg-red-600 text-white font-medium hover:bg-red-700 transition-colors">
                                Aceptar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('custom-confirmation-modal');
            document.getElementById('confirm-ok-btn').onclick = () => {
                onConfirm();
                modal.remove();
            };
            document.getElementById('confirm-cancel-btn').onclick = () => {
                modal.remove();
            };
        }

        async function openEditItemModal(itemId) {
            const itemRef = doc(db, `artifacts/${restaurantAppId}/menuItems`, itemId);
            const itemSnap = await getDoc(itemRef);
            if (!itemSnap.exists()) {
                showNotification('Producto no encontrado para editar.', 'error');
                return;
            }
            const itemToEdit = { id: itemSnap.id, ...itemSnap.data() };

            const modalTitle = `Editar Producto: ${itemToEdit.name}`;
            const categoriesHtml = ['Bebidas Calientes', 'Bebidas Fr√≠as', 'Panader√≠a', 'Postres', 'Comidas'].map(cat => `
                <option value="${cat}" ${itemToEdit.category === cat ? 'selected' : ''}>${cat}</option>
            `).join('');

            const imagesHtml = [
                'üçΩÔ∏è Gen√©rico', '‚òï Caf√©', 'ü•§ Bebida', 'ü•ê Panader√≠a', 'üç∞ Postre', 'üçï Comida',
                'üçî Hamburguesa', 'ü•™ Sandwich', 'ü•ó Ensalada', 'üçù Pasta', 'ü•ß Tarta',
                'üç´ Brownie', 'üçÆ Tiramis√∫', 'üßÉ Jugo', 'üçã Limonada', 'üßä T√© Helado',
                'üçû Pan', 'üßÅ Muffin', 'ü•Ø Bagel'
            ].map(img => {
                const value = img.split(' ')[0]; 
                return `<option value="${value}" ${itemToEdit.image === value ? 'selected' : ''}>${img}</option>`;
            }).join('');

            const modalContent = `
                <div id="edit-item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl max-w-lg w-full mx-4">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6">${modalTitle}</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="editItemName" class="block text-gray-700 text-sm font-bold mb-2">Nombre del Producto:</label>
                                <input id="editItemName" type="text" value="${itemToEdit.name}" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                            </div>
                            <div>
                                <label for="editItemPrice" class="block text-gray-700 text-sm font-bold mb-2">Precio:</label>
                                <input id="editItemPrice" type="number" step="1" value="${itemToEdit.price}" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                            </div>
                            <div>
                                <label for="editItemCategory" class="block text-gray-700 text-sm font-bold mb-2">Categor√≠a:</label>
                                <select id="editItemCategory" class="w-full p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
                                    ${categoriesHtml}
                                </select>
                            </div>
                            <div>
                                <label for="editItemImage" class="block text-gray-700 text-sm font-bold mb-2">Emoji/S√≠mbolo:</label>
                                <select id="editItemImage" class="w-full p-3 border rounded-lg text-xl">
                                    ${imagesHtml}
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 sm:space-x-4 mt-8">
                            <button id="edit-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors text-sm sm:text-base">
                                Cancelar
                            </button>
                            <button id="edit-save-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors text-sm sm:text-base">
                                Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);

            const modalElement = document.getElementById('edit-item-modal');
            document.getElementById('edit-save-btn').onclick = () => saveEditedMenuItem(itemId);
            document.getElementById('edit-cancel-btn').onclick = () => modalElement.remove();
        }

        async function saveEditedMenuItem(itemId) {
            const updatedName = document.getElementById('editItemName').value.trim();
            const updatedPrice = parseFloat(document.getElementById('editItemPrice').value);
            const updatedCategory = document.getElementById('editItemCategory').value;
            const updatedImage = document.getElementById('editItemImage').value;

            if (!updatedName || isNaN(updatedPrice) || updatedPrice <= 0 || !updatedCategory || !updatedImage) {
                showNotification('Por favor, completa todos los campos para el producto.', 'error');
                return; 
            }

            try {
                const itemRef = doc(db, `artifacts/${restaurantAppId}/menuItems`, itemId);
                await updateDoc(itemRef, {
                    name: updatedName,
                    price: updatedPrice,
                    category: updatedCategory,
                    image: updatedImage
                });
                showNotification(`‚úÖ Producto "${updatedName}" actualizado exitosamente.`, 'success');
                document.getElementById('edit-item-modal').remove(); 
            }
            // Catch error and log more details for debugging
            catch (e) {
                console.error("Error saving edited menu item:", e.code, e.message, e);
                showNotification(`Error al guardar los cambios del producto: ${e.message}.`, 'error');
            }
        }

        async function addTable() {
            const newTableNum = document.getElementById('newTableId').value.trim();
            if (!newTableNum || isNaN(parseInt(newTableNum)) || parseInt(newTableNum) <= 0) {
                showNotification('Por favor, ingresa un n√∫mero de mesa v√°lido.', 'error');
                return;
            }
            if (appState.tables.includes(newTableNum)) {
                showNotification('Esa mesa ya existe.', 'error');
                return;
            }
            try {
                const tablesDocRef = doc(db, `artifacts/${restaurantAppId}/tables`, 'tableList');
                const docSnap = await getDoc(tablesDocRef);
                let currentTables = ['0']; // Ensure '0' is always present for 'Para Llevar'
                if (docSnap.exists()) {
                    currentTables = docSnap.data().tableIds || ['0'];
                }
                const updatedTables = [...new Set([...currentTables, newTableNum])].sort((a,b) => parseInt(a)-parseInt(b));
                await setDoc(tablesDocRef, { tableIds: updatedTables });
                showNotification(`ü™ë Mesa ${newTableNum} agregada.`, 'success');
                document.getElementById('newTableId').value = '';
            }
            // Catch error and log more details for debugging
            catch (e) {
                console.error("Error adding table:", e.code, e.message, e);
                showNotification(`Error al agregar la mesa: ${e.message}.`, 'error');
            }
        }

        async function deleteTable(tableToDelete) {
            if (tableToDelete === '0') {
                showNotification('No puedes eliminar la opci√≥n "Para Llevar / Mesa 0".', 'error');
                return;
            }
            showCustomConfirmation(`¬øEst√°s seguro de que quieres eliminar la Mesa ${tableToDelete}?`, async () => {
                try {
                    const tablesDocRef = doc(db, `artifacts/${restaurantAppId}/tables`, 'tableList');
                    const docSnap = await getDoc(tablesDocRef);
                    let currentTables = ['0']; // Ensure '0' is always present
                    if (docSnap.exists()) {
                        currentTables = docSnap.data().tableIds || ['0'];
                    }
                    const updatedTables = currentTables.filter(id => id !== tableToDelete);
                    await setDoc(tablesDocRef, { tableIds: updatedTables });
                    showNotification(`üóëÔ∏è Mesa ${tableToDelete} eliminada.`, 'info');
                }
                // Catch error and log more details for debugging
                catch (e) {
                    console.error("Error deleting table:", e.code, e.message, e);
                    showNotification(`Error al eliminar la mesa: ${e.message}.`, 'error');
                }
            });
        }

        function applyDateFilter() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;

            filterStartDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : null; 
            filterEndDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : null;     

            if (filterStartDate && filterEndDate && filterStartDate > filterEndDate) { 
                showNotification('La fecha de inicio no puede ser posterior a la fecha de fin.', 'error');
                filterStartDate = null;
                filterEndDate = null;
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
            }
            renderAdminView();
        }

        function clearDateFilter() {
            filterStartDate = null;
            filterEndDate = null;
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            renderAdminView();
        }

        function showChartData(dateString, sales, expenses) {
            const modal = document.getElementById('chart-data-modal');
            document.getElementById('modal-date').textContent = new Date(dateString).toLocaleDateString('es-ES');
            document.getElementById('modal-sales').textContent = formatCurrency(sales);
            document.getElementById('modal-expenses').textContent = formatCurrency(expenses);
            
            const netIncome = sales - expenses;
            const netIncomeSpan = document.getElementById('modal-net-income');
            netIncomeSpan.textContent = formatCurrency(netIncome);
            netIncomeSpan.classList.remove('text-green-600', 'text-red-600');
            if (netIncome >= 0) {
                netIncomeSpan.classList.add('text-green-600');
            } else {
                netIncomeSpan.classList.add('text-red-600');
            }
            modal.classList.remove('hidden');
        }

        function exportReportsToPDF() {
            window.print();
        }

        // --- User Management View ---
        function renderUserManagementView() {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) {
                console.warn("main-content not found when trying to render User Management View.");
                return; 
            }
            if (!checkRoleAccess(['admin'])) return; // Only admin can access this view

            let userManagementHtml = `
                <div class="max-w-4xl mx-auto bg-white/90 backdrop-blur-lg p-6 sm:p-8 rounded-2xl shadow-2xl border border-white/20">
                    <h2 class="text-3xl sm:text-4xl font-black bg-gradient-to-r from-indigo-600 to-teal-600 bg-clip-text text-transparent mb-8 text-center">
                        üßë‚Äçüíª Gesti√≥n de Usuarios
                    </h2>
                    <p class="text-gray-600 mb-6 text-center">Aqu√≠ puedes ver y modificar los roles de los usuarios registrados.</p>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-100 border-b-2 border-gray-200">
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Correo</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Rol Actual</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Cambiar Rol</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appState.users.filter(user => user.id !== currentUserId).map(user => `
                                    <tr class="border-b last:border-b-0 hover:bg-gray-50">
                                        <td class="py-3 px-4 text-sm text-gray-800">${user.email || user.id}</td>
                                        <td class="py-3 px-4 text-sm font-medium text-gray-900 capitalize">${user.role}</td>
                                        <td class="py-3 px-4">
                                            <select onchange="updateUserRole('${user.id}', this.value)" class="p-2 border rounded-md text-sm bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="customer" ${user.role === 'customer' ? 'selected' : ''}>Cliente</option>
                                                <option value="cashier" ${user.role === 'cashier' ? 'selected' : ''}>Cajero</option>
                                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrador</option>
                                            </select>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${appState.users.length === 1 && appState.users[0].id === currentUserId ? `
                                    <tr>
                                        <td colspan="3" class="py-4 text-center text-gray-500">
                                            No hay otros usuarios para gestionar.
                                        </td>
                                    </tr>
                                ` : appState.users.length === 0 ? `
                                    <tr>
                                        <td colspan="3" class="py-4 text-center text-gray-500">
                                            No hay usuarios registrados en el sistema.
                                        </td>
                                    </tr>
                                ` : ''}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-8 text-center">
                        <button onclick="switchView('admin')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold text-base sm:text-lg shadow-md transition-all duration-300 transform hover:scale-105">
                            ‚Ü©Ô∏è Volver al Panel de Administraci√≥n
                        </button>
                    </div>
                </div>
            `;
            mainContent.innerHTML = userManagementHtml;
        }

        async function updateUserRole(userId, newRole) {
            try {
                const userRef = doc(db, `artifacts/${restaurantAppId}/users`, userId);
                await updateDoc(userRef, { role: newRole });
                showNotification(`‚úÖ Rol de usuario actualizado a "${newRole}".`, 'success');
            } catch (e) {
                console.error("Error updating user role:", e.code, e.message, e);
                showNotification(`Error al actualizar el rol: ${e.message}. Aseg√∫rate de tener permisos de administrador.`, 'error');
            }
        }

        // --- Main App Layout Rendering ---
        function renderAppLayout() {
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 flex flex-col">
                    <header class="bg-white/80 backdrop-blur-lg border-b border-white/20 shadow-lg sticky top-0 z-50 px-4 py-3 sm:px-6 sm:py-4">
                        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
                            <div class="flex items-center mb-2 sm:mb-0">
                                ${appState.restaurantLogo ? `<img src="${appState.restaurantLogo}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0A0A0/FFFFFF?text=LOGO';" alt="Logo" class="h-8 w-8 sm:h-10 sm:w-10 rounded-full mr-2">` : ''}
                                <h1 class="text-2xl sm:text-3xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                                    ${appState.restaurantName}
                                </h1>
                            </div>
                            <div class="flex flex-wrap justify-center gap-2 sm:space-x-2">
                                <button
                                    id="customer-view-btn"
                                    onclick="switchView('customer')"
                                    class="view-btn px-4 py-2 sm:px-6 sm:py-3 rounded-xl font-bold text-sm sm:text-base transition-all duration-300 transform hover:scale-105"
                                >
                                    üõçÔ∏è Cliente
                                </button>
                                <button
                                    id="cashier-view-btn"
                                    onclick="switchView('cashier')"
                                    class="view-btn px-4 py-2 sm:px-6 sm:py-3 rounded-xl font-bold text-sm sm:text-base transition-all duration-300 transform hover:scale-105"
                                >
                                    üë®‚Äçüç≥ Cajero
                                </button>
                                <button
                                    id="admin-view-btn"
                                    onclick="switchView('admin')"
                                    class="view-btn px-4 py-2 sm:px-6 sm:py-3 rounded-xl font-bold text-sm sm:text-base transition-all duration-300 transform hover:scale-105"
                                >
                                    ‚öôÔ∏è Admin
                                </button>
                                <button
                                    id="user-view-btn"
                                    onclick="switchView('user')"
                                    class="view-btn px-4 py-2 sm:px-6 sm:py-3 rounded-xl font-bold text-sm sm:text-base transition-all duration-300 transform hover:scale-105"
                                >
                                    üë§ Usuario
                                </button>
                                <button
                                    onclick="handleSignOut()"
                                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-xl font-bold text-sm sm:text-base transition-all duration-300 transform hover:scale-105"
                                >
                                    üö™ Salir
                                </button>
                            </div>
                        </div>
                    </header>

                    <main id="main-content" class="flex-grow p-4 sm:p-6"></main>

                    <footer class="bg-white/80 backdrop-blur-lg border-t border-white/20 p-3 sm:p-4 text-center text-xs sm:text-sm">
                        <div class="max-w-7xl mx-auto">
                            <p class="text-gray-600">üí° Sistema desarrollado con tecnolog√≠as web modernas | üìä Datos almacenados en la nube</p>
                            <p class="text-gray-500 mt-1 sm:mt-2">
                                App ID: <span id="app-id-display" class="font-semibold text-gray-700">Cargando...</span> | Usuario ID: <span id="user-id-display" class="font-semibold text-gray-700">Cargando...</span>
                                | Rol: <span id="user-role-display" class="font-semibold text-gray-700">${currentUserRole.toUpperCase()}</span>
                            </p>
                            <p class="text-gray-500 mt-1 sm:mt-2">
                                &copy; 2025 ${appState.restaurantName}. Dise√±ado para negocios modernos por
                                <a href="https://www.instagram.com/oscar_sierra_2921/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-semibold inline-flex items-center">
                                    üòéü§ûüëâ
                                </a>
                            </p>
                        </div>
                    </footer>
                </div>
            `;
            document.getElementById('app-title').textContent = `${appState.restaurantName} - Sistema de Pedidos Restaurante`;
            updateHeaderDisplay(); // Ensure header and footer reflect latest data
        }

        function updateHeaderDisplay() {
            const headerH1 = document.querySelector('header h1');
            let headerLogo = document.querySelector('header img');
            const footerTextContainer = document.querySelector('footer p:last-child');
            const appIdDisplay = document.getElementById('app-id-display');
            const userIdDisplay = document.getElementById('user-id-display');
            const userRoleDisplay = document.getElementById('user-role-display');
            const appTitle = document.getElementById('app-title');

            if (headerH1) {
                headerH1.textContent = appState.restaurantName;
            }
            if (appState.restaurantLogo) {
                if (headerLogo) {
                    headerLogo.src = appState.restaurantLogo;
                } else {
                    const logoElement = document.createElement('img');
                    logoElement.src = appState.restaurantLogo;
                    logoElement.alt = "Logo";
                    logoElement.className = "h-8 w-8 sm:h-10 sm:w-10 rounded-full mr-2";
                    logoElement.onerror = function() { this.onerror=null;this.src='https://placehold.co/100x100/A0A0A0/FFFFFF?text=LOGO'; }; 
                    document.querySelector('header .flex.items-center').prepend(logoElement);
                }
            } else {
                if (headerLogo) headerLogo.remove();
            }
            if (footerTextContainer) {
                const copyrightP = footerTextContainer.previousElementSibling.previousElementSibling;
                if (copyrightP) {
                    copyrightP.innerHTML = `&copy; 2025 ${appState.restaurantName}. Dise√±ado para negocios modernos por`;
                }
                const instagramLinkP = footerTextContainer.previousElementSibling;
                 if (instagramLinkP) {
                     instagramLinkP.innerHTML = `
                        <a href="https://www.instagram.com/oscar_sierra_2921/" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-semibold inline-flex items-center">
                            üòéü§ûüëâ
                        </a>
                     `;
                 }
            }
            if (appIdDisplay) {
                appIdDisplay.textContent = restaurantAppId;
            }
            if (userIdDisplay) {
                userIdDisplay.textContent = currentUserId;
            }
            if (userRoleDisplay) {
                userRoleDisplay.textContent = currentUserRole.toUpperCase();
            }
            if (appTitle) {
                appTitle.textContent = `${appState.restaurantName} - Sistema de Pedidos Restaurante`;
            }
        }

        // Function to check if the current user has access to a specific view based on their role
        function checkRoleAccess(allowedRoles) {
            if (allowedRoles.includes(currentUserRole)) {
                return true;
            } else {
                showNotification(`Acceso denegado. Se requiere el rol de ${allowedRoles.join(' o ')}. Su rol actual es: ${currentUserRole}.`, 'error', 5000);
                // Optionally redirect to a default allowed view or the login page
                if (currentUserRole === 'guest') {
                    // If guest, ensure they see the auth screen
                    renderAuthView();
                } else {
                    // If authenticated but no access, maybe redirect to customer view as default for non-admin/cashier roles
                    if (currentView !== 'customer') { // Prevent infinite loop if customer view is also restricted
                         currentView = 'customer';
                         renderCustomerView();
                    }
                }
                return false;
            }
        }

        function switchView(view) {
            if (!isFirebaseReady) {
                showNotification('El sistema a√∫n se est√° inicializando. Por favor, espere.', 'info', 2000);
                return;
            }

            // Define allowed roles for each view
            const viewAccess = {
                'customer': ['customer', 'cashier', 'admin'],
                'cashier': ['cashier', 'admin'],
                'admin': ['admin'],
                'user': ['customer', 'cashier', 'admin'], // All authenticated users can manage their own settings
                'user-management': ['admin'] // Only admin can access user management
            };

            if (!checkRoleAccess(viewAccess[view])) {
                return; // Do not switch view if access is denied
            }

            currentView = view;
            
            const buttons = document.querySelectorAll('.view-btn');
            buttons.forEach(btn => {
                btn.classList.remove('bg-gradient-to-r', 'from-blue-600', 'to-purple-600', 'text-white', 'shadow-lg');
                btn.classList.add('bg-white/70', 'text-gray-700', 'hover:bg-white/90');
            });
            
            const activeBtn = document.getElementById(`${view}-view-btn`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-white/70', 'text-gray-700', 'hover:bg-white/90');
                activeBtn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-purple-600', 'text-white', 'shadow-lg');
            }

            switch(view) {
                case 'customer':
                    renderCustomerView();
                    break;
                case 'cashier':
                    renderCashierView();
                    break;
                case 'admin':
                    renderAdminView();
                    break;
                case 'user': 
                    renderUserView();
                    break;
                case 'user-management':
                    renderUserManagementView();
                    break;
            }
        }

        // Moved Firestore listeners into a separate function to be called after auth
        function setupFirestoreListeners() {
            onSnapshot(collection(db, `artifacts/${restaurantAppId}/orders`), (snapshot) => {
                appState.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Orders updated:", appState.orders.length);
                if (isFirebaseReady) { // Only attempt to re-render if Firebase is fully ready
                    if (currentView === 'cashier') renderCashierView();
                    if (currentView === 'admin') renderAdminView();
                }
            }, (error) => {
                console.error("Error fetching orders:", error.code, error.message, error);
                showNotification(`Error al cargar pedidos: ${error.message}. Recargue la p√°gina.`, 'error', 7000);
            });

            onSnapshot(collection(db, `artifacts/${restaurantAppId}/menuItems`), (snapshot) => {
                appState.menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Menu items updated:", appState.menuItems.length);
                if (isFirebaseReady) {
                    if (currentView === 'customer') renderCustomerView();
                    if (currentView === 'admin') renderAdminView();
                }
            }, (error) => {
                console.error("Error fetching menu items:", error.code, error.message, error);
                showNotification(`Error al cargar men√∫: ${error.message}. Recargue la p√°gina.`, 'error', 7000);
            });

            onSnapshot(collection(db, `artifacts/${restaurantAppId}/expenses`), (snapshot) => {
                appState.expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Expenses updated:", appState.expenses.length);
                appState.dailyStats.totalExpensesToday = getExpensesForDate(new Date().toDateString());
                if (isFirebaseReady) {
                    if (currentView === 'admin') renderAdminView();
                }
            }, (error) => {
                console.error("Error fetching expenses:", error.code, error.message, error);
                showNotification(`Error al cargar gastos: ${error.message}. Recargue la p√°gina.`, 'error', 7000);
            });

            onSnapshot(collection(db, `artifacts/${restaurantAppId}/financialHistory`), (snapshot) => {
                appState.financialHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                appState.financialHistory.sort((a, b) => new Date(a.date) - new Date(b.date)); 
                console.log("Financial history updated:", appState.financialHistory.length);
                if (isFirebaseReady) {
                    if (currentView === 'admin') renderAdminView();
                }
            }, (error) => {
                console.error("Error fetching financial history:", error.code, error.message, error);
                showNotification(`Error al cargar historial financiero: ${error.message}. Recargue la p√°gina.`, 'error', 7000);
            });

            onSnapshot(doc(db, `artifacts/${restaurantAppId}/tables`, 'tableList'), (docSnap) => {
                if (docSnap.exists()) {
                    appState.tables = docSnap.data().tableIds || ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10']; 
                } else {
                    // Only set initial data if it doesn't exist, to avoid unnecessary writes
                    setDoc(doc(db, `artifacts/${restaurantAppId}/tables`, 'tableList'), { tableIds: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'] }, { merge: true });
                    appState.tables = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
                }
                appState.tables.sort((a,b) => parseInt(a)-parseInt(b)); 
                console.log("Tables updated:", appState.tables.length);
                if (isFirebaseReady) {
                    if (currentView === 'customer') renderCustomerView();
                    if (currentView === 'admin') renderAdminView();
                }
            }, (error) => {
                console.error("Error fetching tables:", error.code, error.message, error);
                showNotification(`Error al cargar mesas: ${error.message}. Recargue la p√°gina.`, 'error', 7000);
            });

            onSnapshot(doc(db, `artifacts/${restaurantAppId}/settings`, 'restaurantSettings'), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    appState.restaurantName = data.restaurantName || 'SISTEPRO';
                    appState.restaurantLogo = data.restaurantLogo || '';
                } else {
                    setDoc(doc(db, `artifacts/${restaurantAppId}/settings`, 'restaurantSettings'), { restaurantName: 'SISTEPRO', restaurantLogo: '' }, { merge: true });
                }
                console.log("Restaurant settings updated.");
                if (isFirebaseReady) {
                    updateHeaderDisplay(); 
                }
            }, (error) => {
                console.error("Error fetching restaurant settings:", error.code, error.message, error);
                showNotification(`Error al cargar la configuraci√≥n del restaurante: ${error.message}. Recargue la p√°gina.`, 'error', 7000);
            });

            onSnapshot(collection(db, `artifacts/${restaurantAppId}/users`), (snapshot) => {
                appState.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Users updated:", appState.users.length);
                if (isFirebaseReady) {
                    if (currentView === 'user-management') renderUserManagementView();
                }
            }, (error) => {
                console.error("Error fetching users:", error.code, error.message, error);
                showNotification(`Error al cargar usuarios: ${error.message}. Recargue la p√°gina.`, 'error', 7000);
            });

            const todayString = new Date().toDateString();
            onSnapshot(doc(db, `artifacts/${restaurantAppId}/dailyStats`, todayString), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    appState.dailyStats = {
                        sales: data.sales || 0,
                        orders: data.orders || 0,
                        date: data.date || todayString,
                        totalRevenueToday: data.totalRevenueToday || 0,
                        totalExpensesToday: data.totalExpensesToday || 0
                    };
                } else {
                    setDoc(doc(db, `artifacts/${restaurantAppId}/dailyStats`, todayString), {
                        sales: 0,
                        orders: 0,
                        date: todayString,
                        totalRevenueToday: 0,
                        totalExpensesToday: 0
                    }, { merge: true }); // Use merge to avoid overwriting if other fields exist
                    appState.dailyStats = { sales: 0, orders: 0, date: todayString, totalRevenueToday: 0, totalExpensesToday: 0 };
                }
                console.log("Daily stats updated.");
                if (isFirebaseReady) {
                    if (currentView === 'cashier') renderCashierView();
                    if (currentView === 'admin') renderAdminView();
                }
            }, (error) => {
                console.error("Error fetching daily stats:", error.code, error.message, error);
                showNotification(`Error al cargar estad√≠sticas diarias: ${error.message}. Recargue la p√°gina.`, 'error', 7000);
            });
        }

        // --- App Initialization ---
        async function initApp() {
            // Ensure restaurantAppId is properly initialized.
            // If running in Canvas, __app_id will be available. Otherwise, use a default ID.
            restaurantAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-restaurant-id';
            
            console.log("DEBUG: Current restaurantAppId:", restaurantAppId); // <<< ADDED FOR DEBUGGING

            let firebaseConfig = {};
            let configSource = 'hardcoded_fallback'; // Default source
            let configParsingError = false;

            // Try to parse __firebase_config if it's available (from Canvas environment)
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                    configSource = 'canvas_global_variable';
                    console.log("Firebase config loaded from Canvas global variable (__firebase_config).");
                } catch (e) {
                    console.error("Error parsing __firebase_config:", e.message, e);
                    showNotification(`üö® ERROR CR√çTICO: Configuraci√≥n de Firebase no v√°lida desde el entorno. Mensaje: ${e.message}. Se intentar√° usar configuraci√≥n por defecto.`, 'error', 15000);
                    configParsingError = true;
                }
            }

            // If parsing failed or __firebase_config was not available, use hardcoded values
            if (configSource === 'hardcoded_fallback' || configParsingError || !firebaseConfig.projectId || !firebaseConfig.apiKey) {
                console.warn("Using hardcoded Firebase config. This is expected if running locally outside the Canvas environment or if global config failed to load/parse.");
                firebaseConfig = {
                    apiKey: "AIzaSyBa3wSnKKusJZAKDpA_KaC7JupU0tqGEMM", // REEMPLAZA ESTO CON TU CLAVE API REAL DE FIREBASE
                    authDomain: "agroinsight-colombia.firebaseapp.com",
                    projectId: "agroinsight-colombia",
                    storageBucket: "agroinsight-colombia.appspot.com",
                    messagingSenderId: "601872739262",
                    // For local development when __app_id is not present, use a local default appId.
                    // This is different from the appId provided in firebaseConfig from the console.
                    appId: typeof __app_id !== 'undefined' ? __app_id : '1:601872739262:web:default-local-app-id' 
                };
                configSource = 'hardcoded_fallback_used';
            }

            // Final check on essential keys before initializing
            if (!firebaseConfig.projectId || !firebaseConfig.apiKey) {
                console.error("Error CR√çTICO: Firebase projectId o apiKey faltantes despu√©s de todos los intentos de carga.");
                showNotification("üö® ERROR CR√çTICO: Firebase Project ID o API Key son necesarios para iniciar la aplicaci√≥n y no se pudieron cargar. Por favor, aseg√∫rate de que tu configuraci√≥n de Firebase sea correcta.", 'error', 15000);
                isFirebaseReady = true;
                renderAuthView();
                return; // Stop initialization
            }

            // Log the final config for debugging
            console.log("Firebase Config final (antes de initializeApp):", firebaseConfig);

            firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            auth = getAuth(firebaseApp);

            // Listen for authentication state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Firebase Authenticated as:", currentUserId);

                    // Fetch user role from Firestore
                    const userRoleDocRef = doc(db, `artifacts/${restaurantAppId}/users`, user.uid);
                    const userRoleSnap = await getDoc(userRoleDocRef);

                    if (userRoleSnap.exists()) {
                        currentUserRole = userRoleSnap.data().role;
                    } else {
                        // If user document doesn't exist (e.g., first login after anonymous was removed, or new user before data propagation)
                        // Create a user document with a default 'customer' role
                        currentUserRole = 'customer';
                        await setDoc(userRoleDocRef, { email: user.email, role: currentUserRole }, { merge: true }); // Use merge
                    }
                    console.log("User Role:", currentUserRole);

                    // Set up real-time listeners for all main app data *after* authentication
                    setupFirestoreListeners();

                    // Perform daily/weekly resets *after* authentication and data load
                    const initialToday = new Date();
                    const initialTodayString = initialToday.toDateString();
                    const initialCurrentWeekStart = getStartOfWeek(initialToday);

                    if (appState.dailyStats.date && appState.dailyStats.date !== initialTodayString) {
                        const previousDayDate = appState.dailyStats.date;
                        const previousDaySales = appState.dailyStats.totalRevenueToday; 
                        const previousDayExpenses = appState.dailyStats.totalExpensesToday; 

                        const financialHistoryDocRef = doc(db, `artifacts/${restaurantAppId}/financialHistory`, previousDayDate);
                        const docSnap = await getDoc(financialHistoryDocRef);

                        if (!docSnap.exists()) {
                            await setDoc(financialHistoryDocRef, {
                                date: previousDayDate,
                                sales: previousDaySales,
                                expenses: previousDayExpenses
                            }, { merge: true }); // Use merge
                            console.log("Previous day's financial history recorded.");
                        } else {
                            console.log("Previous day's financial history already recorded.");
                        }
                    }

                    if (appState.dailyStats.date !== initialTodayString) {
                        const dailyStatsDocRef = doc(db, `artifacts/${restaurantAppId}/dailyStats`, initialTodayString);
                        await setDoc(dailyStatsDocRef, { sales: 0, orders: 0, date: initialTodayString, totalRevenueToday: 0, totalExpensesToday: 0 }, { merge: true }); // Use merge
                        console.log("Daily stats reset for new day.");
                    }

                    const settingsDocRef = doc(db, `artifacts/${restaurantAppId}/settings`, 'restaurantSettings');
                    const settingsSnap = await getDoc(settingsDocRef);
                    let currentLastWeeklyReportReset = appState.lastWeeklyReportReset;
                    if (settingsSnap.exists() && settingsSnap.data().lastWeeklyReportReset) {
                        currentLastWeeklyReportReset = new Date(settingsSnap.data().lastWeeklyReportReset);
                    }
                    
                    if (currentLastWeeklyReportReset.getTime() !== initialCurrentWeekStart.getTime()) {
                        await updateDoc(settingsDocRef, { lastWeeklyReportReset: initialCurrentWeekStart.toISOString() });
                        appState.lastWeeklyReportReset = initialCurrentWeekStart; 
                        console.log("Weekly report reset date updated.");
                    }
                    
                    isFirebaseReady = true; 
                    renderAppLayout(); 
                    switchView(currentView); 
                    showNotification('üéâ Sistema iniciado y sincronizado con la nube correctamente', 'success', 3000);

                } else {
                    // User is signed out or not authenticated
                    currentUserId = 'N/A';
                    currentUserRole = 'guest';
                    isFirebaseReady = true; // Mark ready to show login form
                    renderAuthView(); // Show login/signup form
                    showNotification('Inicie sesi√≥n para acceder al sistema.', 'info', 3000);
                }
            });
        }

        // --- Global Functions available in the window scope ---
        window.setTableId = setTableId; 
        window.handleQuantityChange = handleQuantityChange;
        window.handleSubmitOrder = handleSubmitOrder;
        window.switchView = switchView;
        window.filterOrders = filterOrders;
        window.updateOrderStatus = updateOrderStatus;
        window.deleteOrder = deleteOrder;
        window.clearAllOrders = clearAllOrders;
        window.exportDataToCSV = exportDataToCSV; 
        window.addMenuItem = addMenuItem;
        window.toggleItemAvailability = toggleItemAvailability;
        window.deleteMenuItem = deleteMenuItem;
        window.showCustomConfirmation = showCustomConfirmation; 
        window.addExpense = addExpense; 
        window.deleteExpense = deleteExpense; 
        window.clearAllExpenses = clearAllExpenses; 
        window.openEditItemModal = openEditItemModal;
        window.saveEditedMenuItem = saveEditedMenuItem;
        window.addTable = addTable; 
        window.deleteTable = deleteTable; 
        window.applyDateFilter = applyDateFilter; 
        window.clearDateFilter = clearDateFilter; 
        window.renderUserView = renderUserView; 
        window.saveRestaurantSettings = saveRestaurantSettings; 
        window.showChartData = showChartData; 
        window.exportReportsToPDF = exportReportsToPDF; 
        window.setManualQuantity = setManualQuantity; 
        window.toggleCompletedOrdersInCashier = toggleCompletedOrdersInCashier; 
        window.handleSignIn = handleSignIn; // New authentication functions
        window.handleSignUp = handleSignUp;
        window.handleSignOut = handleSignOut;
        window.updateUserRole = updateUserRole; // New function for user role management
        window.renderUserManagementView = renderUserManagementView; // Make available globally

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initApp);
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
